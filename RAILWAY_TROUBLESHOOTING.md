# Railway Deployment Troubleshooting Guide

## üîç Common Reasons Why Laravel Apps Crash on Railway

### 1. **Missing Environment Variables**
**Symptoms:** App crashes immediately, 500 errors
**Solution:** Ensure these variables are set in Railway dashboard:

**Required Variables:**
```
APP_KEY=base64:C+kiffgn6xdlxsBUdYno57+AhYtdrqUFLSn1Zso0lcA=
APP_ENV=production
APP_DEBUG=false
RAILWAY_STATIC_URL=${{RAILWAY_STATIC_URL}}
```

### 2. **Database Connection Issues**
**Symptoms:** App starts but crashes when accessing database
**Solution:** 
- Ensure MySQL service is added to Railway project
- Database variables are auto-generated by Railway
- Wait for database to be fully provisioned (can take 2-3 minutes)

### 3. **Missing Storage Directories**
**Symptoms:** Permission errors, cache errors
**Solution:** Fixed in updated Dockerfile - creates required directories

### 4. **Composer Dependencies**
**Symptoms:** Class not found errors, autoload errors
**Solution:** Fixed in updated Dockerfile - proper composer install sequence

### 5. **Asset Build Issues**
**Symptoms:** Missing CSS/JS files, Vite errors
**Solution:** Added Node.js and npm build process to Dockerfile

## üîß **How to Debug Railway Deployment**

### **Step 1: Check Railway Logs**
1. Go to Railway dashboard
2. Click on your service
3. Go to "Deployments" tab
4. Click on latest deployment
5. Check both "Build Logs" and "Deploy Logs"

### **Step 2: Common Error Messages**

#### **"Class not found" Errors**
```bash
# In Railway logs, run:
composer dump-autoload --optimize
```

#### **"No application encryption key" Error**
```bash
# Set in Railway environment variables:
APP_KEY=base64:C+kiffgn6xdlxsBUdYno57+AhYtdrqUFLSn1Zso0lcA=
```

#### **Database Connection Errors**
```bash
# Check if MySQL service is running
# Verify environment variables are set
# Wait for database provisioning to complete
```

#### **Permission Errors**
```bash
# Fixed in Dockerfile with proper permissions
chmod -R 755 storage bootstrap/cache
```

### **Step 3: Test Endpoints**

#### **Health Check**
```
https://your-app.railway.app/health
```
Should return:
```json
{
  "status": "ok",
  "timestamp": "2024-12-19T10:30:00.000000Z",
  "app": "Palsa POS",
  "version": "1.0.0"
}
```

#### **Basic Laravel Route**
```
https://your-app.railway.app/
```
Should redirect to login page

## üöÄ **Fixed Issues in Updated Configuration**

### **Dockerfile Improvements:**
1. ‚úÖ **Better dependency management** - Composer files copied first
2. ‚úÖ **Directory creation** - All required directories created
3. ‚úÖ **Permission fixes** - Proper ownership and permissions
4. ‚úÖ **Asset building** - Node.js and npm included
5. ‚úÖ **Database wait** - Waits for database connection
6. ‚úÖ **Error handling** - Better error messages and recovery
7. ‚úÖ **Apache configuration** - Proper rewrite rules

### **Environment Improvements:**
1. ‚úÖ **Database charset** - UTF8MB4 for proper character support
2. ‚úÖ **Logging configuration** - Proper error logging
3. ‚úÖ **Cache configuration** - Database-based caching

## üìã **Deployment Checklist**

### **Before Deploying:**
- [ ] MySQL service added to Railway project
- [ ] Environment variables set in Railway dashboard
- [ ] Code pushed to GitHub repository
- [ ] Railway connected to GitHub repository

### **Required Environment Variables:**
- [ ] `APP_KEY` - Laravel application key
- [ ] `APP_ENV=production` - Production environment
- [ ] `APP_DEBUG=false` - Disable debug mode
- [ ] `RAILWAY_STATIC_URL` - Set to `${{RAILWAY_STATIC_URL}}`

### **Database Variables (Auto-generated):**
- [ ] `MYSQLHOST` - Database host
- [ ] `MYSQLPORT` - Database port
- [ ] `MYSQLDATABASE` - Database name
- [ ] `MYSQLUSER` - Database username
- [ ] `MYSQLPASSWORD` - Database password

### **After Deployment:**
- [ ] Check deployment logs for errors
- [ ] Test health check endpoint
- [ ] Test main application URL
- [ ] Verify database connection
- [ ] Test login functionality

## üÜò **Still Having Issues?**

### **Get Detailed Logs:**
1. Railway Dashboard ‚Üí Your Service ‚Üí Deployments
2. Click latest deployment ‚Üí View logs
3. Look for specific error messages

### **Common Solutions:**

#### **If Build Fails:**
- Check Dockerfile syntax
- Verify all files are in repository
- Check for missing dependencies

#### **If App Starts but Crashes:**
- Check environment variables
- Verify database connection
- Check Laravel logs in Railway dashboard

#### **If Database Issues:**
- Wait 5 minutes for database provisioning
- Check database service status
- Verify connection variables

#### **If Permission Issues:**
- Redeploy (fixed in updated Dockerfile)
- Check storage directory permissions

### **Emergency Fixes:**

#### **Quick Environment Variable Check:**
```bash
# In Railway dashboard, ensure these are set:
APP_KEY=base64:C+kiffgn6xdlxsBUdYno57+AhYtdrqUFLSn1Zso0lcA=
RAILWAY_STATIC_URL=${{RAILWAY_STATIC_URL}}
```

#### **Force Redeploy:**
1. Make small change to code (add comment)
2. Commit and push to GitHub
3. Railway will automatically redeploy

## üéØ **Success Indicators**

### **Successful Deployment:**
- ‚úÖ Build completes without errors
- ‚úÖ Health check returns JSON response
- ‚úÖ Main URL loads (redirects to login)
- ‚úÖ No error messages in logs
- ‚úÖ Database migrations complete

### **Working Application:**
- ‚úÖ Login page loads
- ‚úÖ Can authenticate users
- ‚úÖ Dashboard displays data
- ‚úÖ API endpoints respond
- ‚úÖ Database operations work

---

## üéâ **Once Fixed:**

Your Palsa POS system will be fully functional at:
`https://your-app-name.railway.app`

With all features working:
- Complete POS interface
- Admin dashboard
- API endpoints
- M-Pesa payments
- Database operations